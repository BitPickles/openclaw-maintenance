# Proxy Health Monitor

## æ¦‚è¿°

ç›‘æ§ OpenClaw æ¶ˆæ¯é˜Ÿåˆ—ç§¯å‹ï¼Œè‡ªåŠ¨åˆ‡æ¢ VPN èŠ‚ç‚¹ä»¥æ¢å¤ç½‘ç»œè¿é€šæ€§ã€‚

## æ–‡ä»¶ä½ç½®

| æ–‡ä»¶ | è·¯å¾„ |
|------|------|
| è„šæœ¬ | `~/.openclaw/scripts/proxy-health.sh` |
| LaunchAgent | `~/Library/LaunchAgents/ai.openclaw.proxy-health.plist` |
| æ—¥å¿— | `~/.openclaw/logs/proxy-health.log` |

## è¿è¡Œé¢‘ç‡

æ¯ **1 åˆ†é’Ÿ** æ‰§è¡Œä¸€æ¬¡

## æ ¸å¿ƒé€»è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥ delivery-queue ç§¯å‹ (>3æ¡)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                 â”‚
       æ— ç§¯å‹             æœ‰ç§¯å‹
          â”‚                 â”‚
       ä¸å¤„ç†              â”‚
                           â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  æµ‹è¯•ã€å½“å‰èŠ‚ç‚¹ã€‘å»¶è¿Ÿ   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
              å»¶è¿Ÿæ­£å¸¸            å»¶è¿Ÿå¼‚å¸¸
                  â”‚                 â”‚
                  â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ åˆ¤å®š: OpenClaw   â”‚   â”‚ æ‰¹é‡æ£€æµ‹èŠ‚ç‚¹         â”‚
        â”‚ é—®é¢˜ï¼Œé€šçŸ¥ Boss  â”‚   â”‚ TWN â†’ JPN â†’ HKG     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                 â”‚
                           æ‰¾åˆ°å¥åº·èŠ‚ç‚¹       å…¨éƒ¨ä¸é€š
                               â”‚                 â”‚
                          åˆ‡æ¢èŠ‚ç‚¹         åˆ¤å®š: æœ¬åœ°ç½‘ç»œé—®é¢˜
                          é€šçŸ¥ Boss           åªè®°å½•æ—¥å¿—
```

## åˆ¤å®šé€»è¾‘

| ç§¯å‹ | å½“å‰èŠ‚ç‚¹å»¶è¿Ÿ | åˆ¤å®š | åŠ¨ä½œ |
|------|--------------|------|------|
| â‰¤3 æ¡ | - | æ­£å¸¸ | æ— æ“ä½œ |
| >3 æ¡ | æ­£å¸¸ (<3s) | OpenClaw é—®é¢˜ | é€šçŸ¥ Boss æ’æŸ¥ |
| >3 æ¡ | å¼‚å¸¸ (>3s æˆ–è¶…æ—¶) | èŠ‚ç‚¹é—®é¢˜ | åˆ‡æ¢èŠ‚ç‚¹ |
| >3 æ¡ | å¼‚å¸¸ + æ‰€æœ‰èŠ‚ç‚¹ä¸é€š | æœ¬åœ°ç½‘ç»œé—®é¢˜ | åªè®°å½•æ—¥å¿— |

## èŠ‚ç‚¹åˆ‡æ¢ä¼˜å…ˆçº§

1. **å°æ¹¾ (TWN)** â€” å»¶è¿Ÿä½ï¼Œä¼˜å…ˆä½¿ç”¨
2. **æ—¥æœ¬ (JPN)** â€” æ¬¡é€‰
3. **é¦™æ¸¯ (HKG)** â€” å…œåº•

## é…ç½®å‚æ•°

```bash
# åœ¨è„šæœ¬å¤´éƒ¨ä¿®æ”¹

QUEUE_THRESHOLD=3           # ç§¯å‹é˜ˆå€¼ï¼ˆè¶…è¿‡å¤šå°‘æ¡è§¦å‘æ£€æµ‹ï¼‰
DELAY_TIMEOUT=5000          # å»¶è¿Ÿæµ‹è¯•è¶…æ—¶ (ms)
DELAY_THRESHOLD=3000        # å»¶è¿Ÿè¶…è¿‡æ­¤å€¼è§†ä¸ºå¼‚å¸¸ (ms)
```

## Clash API

è„šæœ¬é€šè¿‡ Clash RESTful API æ§åˆ¶èŠ‚ç‚¹ï¼š

```bash
# API åœ°å€
CLASH_API="http://127.0.0.1:9097"
CLASH_SECRET="set-your-secret"

# è·å–å½“å‰èŠ‚ç‚¹
curl -H "Authorization: Bearer $CLASH_SECRET" "$CLASH_API/proxies/GLOBAL"

# æµ‹è¯•èŠ‚ç‚¹å»¶è¿Ÿ
curl -H "Authorization: Bearer $CLASH_SECRET" \
  "$CLASH_API/proxies/èŠ‚ç‚¹åç§°/delay?timeout=5000&url=https://api.telegram.org"

# åˆ‡æ¢èŠ‚ç‚¹
curl -X PUT -H "Authorization: Bearer $CLASH_SECRET" \
  -H "Content-Type: application/json" \
  "$CLASH_API/proxies/GLOBAL" \
  -d '{"name":"ğŸ‡¨ğŸ‡³ TWN 01"}'
```

## æœåŠ¡ç®¡ç†

```bash
# æŸ¥çœ‹çŠ¶æ€
launchctl list | grep proxy-health

# åœæ­¢æœåŠ¡
launchctl unload ~/Library/LaunchAgents/ai.openclaw.proxy-health.plist

# å¯åŠ¨æœåŠ¡
launchctl load ~/Library/LaunchAgents/ai.openclaw.proxy-health.plist

# æ‰‹åŠ¨æ‰§è¡Œï¼ˆæµ‹è¯•ï¼‰
~/.openclaw/scripts/proxy-health.sh

# æŸ¥çœ‹æ—¥å¿—
tail -f ~/.openclaw/logs/proxy-health.log
```

## ä¸å…¶ä»–ç›‘æ§çš„å…³ç³»

| æœåŠ¡ | èŒè´£ | è§¦å‘åŠ¨ä½œ |
|------|------|----------|
| **proxy-health** | ç›‘æ§ç½‘ç»œ/VPN èŠ‚ç‚¹ | åˆ‡æ¢èŠ‚ç‚¹ |
| **gateway-watchdog** | ç›‘æ§ Gateway è¿›ç¨‹ | é‡å¯ Gateway |

ä¸¤è€…äº’è¡¥ï¼š
- `proxy-health` è§£å†³"ç½‘ç»œä¸é€š"é—®é¢˜
- `gateway-watchdog` è§£å†³"Gateway å´©æºƒ"é—®é¢˜

## é€šçŸ¥

> é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®é€šçŸ¥ç›®æ ‡ï¼š
> ```bash
> export OPENCLAW_NOTIFY_TARGET=123456789
> ```

åˆ‡æ¢èŠ‚ç‚¹æˆ–æ£€æµ‹åˆ° OpenClaw é—®é¢˜æ—¶ï¼Œé€šè¿‡ Telegram é€šçŸ¥ Bossï¼š

```bash
NOTIFY_CHANNEL="telegram"
NOTIFY_TARGET="1311453837"      # Boss çš„ Telegram ID
NOTIFY_ACCOUNT="engineer"       # ä½¿ç”¨å·¥ç¨‹å¸ˆ Bot å‘é€
```

## æ—¥å¿—ç¤ºä¾‹

```
[2026-02-25 10:00:01] [WARN] æ£€æµ‹åˆ°ç§¯å‹: 5 æ¡æ¶ˆæ¯
[2026-02-25 10:00:01] [INFO] å½“å‰èŠ‚ç‚¹: ğŸ‡¨ğŸ‡³ TWN 02
[2026-02-25 10:00:02] [INFO] å½“å‰èŠ‚ç‚¹å»¶è¿Ÿ: -1ms
[2026-02-25 10:00:02] [WARN] å½“å‰èŠ‚ç‚¹å¼‚å¸¸ï¼Œå¼€å§‹æŸ¥æ‰¾å¥åº·èŠ‚ç‚¹...
[2026-02-25 10:00:02] [INFO] æ£€æµ‹ TWN åœ°åŒºèŠ‚ç‚¹...
[2026-02-25 10:00:05] [INFO] æ‰¾åˆ°å¥åº·èŠ‚ç‚¹: ğŸ‡¨ğŸ‡³ TWN 03
[2026-02-25 10:00:05] [OK] å·²åˆ‡æ¢èŠ‚ç‚¹: ğŸ‡¨ğŸ‡³ TWN 02 â†’ ğŸ‡¨ğŸ‡³ TWN 03
```

## æ•…éšœæ’æŸ¥

### è„šæœ¬ä¸æ‰§è¡Œ
```bash
# æ£€æŸ¥ LaunchAgent çŠ¶æ€
launchctl list | grep proxy-health

# æ£€æŸ¥é”™è¯¯æ—¥å¿—
cat ~/.openclaw/logs/proxy-health-stderr.log
```

### Clash API ä¸é€š
```bash
# ç¡®è®¤ Clash è¿è¡Œ
ps aux | grep verge-mihomo

# æµ‹è¯• API
curl -H "Authorization: Bearer set-your-secret" http://127.0.0.1:9097/proxies
```

### èŠ‚ç‚¹åˆ‡æ¢å¤±è´¥
```bash
# æ‰‹åŠ¨æµ‹è¯•åˆ‡æ¢
curl -X PUT -H "Authorization: Bearer set-your-secret" \
  -H "Content-Type: application/json" \
  http://127.0.0.1:9097/proxies/GLOBAL \
  -d '{"name":"ğŸ‡¨ğŸ‡³ TWN 01"}'
```

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´ |
|------|------|------|
| 2026-02-25 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œæ›¿ä»£ telegram-health-check.sh |
